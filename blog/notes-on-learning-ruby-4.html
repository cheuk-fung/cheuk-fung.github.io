<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <title>紅寶石學習筆記（四） &larr; Blog</title>
        <meta name="author" content="Ng Cheuk-fung" />

        <link rel="start" href="/" />

        

        

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/files/css/syntax.css" type="text/css" />

        <!-- Homepage CSS -->
        <link rel="stylesheet" href="/files/css/screen.css" type="text/css" media="all" />
        <link rel="stylesheet" href="/files/css/print.css" type="text/css" media="print" />

        
    </head>
    <body id="">
        <div id="site">

            <div id="header">
    <h1>
    <a href="/blog">Blog</a>
    <span class="byline">&larr; <a href="/">The Stars My Destination</a></span>
</h1>
<ul class="nav">
    <li><a class="home" href="/">Home</a></li>
    <li><a class="info" href="/info">Info</a></li>
    <li><a class="code" href="/code">Code</a></li>
    <li><a class="past" href="/blog/past.html">Past</a></li>
</ul>

</div>


<div id="page">

    <h1 class="emphnext">紅寶石學習筆記（四）</h1>

    <h2 id="misc">Misc</h2>

<h3 id="section">||= 運算子</h3>
<p>由於 <code>+=</code>, <code>-=</code> 等運算子的語義，<code>a ||= b</code> 可能會被理解成 <code>a = a || b</code>。
但實際上，Ruby 將其實現為 <code>a || a = b</code>，
這樣當 <code>a</code> 為真（即不為 <code>nil</code> 或 <code>false</code>）的時候就不會執行賦值操作。</p>

<p><a href="http://www.rubyinside.com/what-rubys-double-pipe-or-equals-really-does-5488.html"><em>What Ruby’s ||= (Double Pipe / Or Equals) Really Does</em></a>
這篇文章的一個測試非常好：</p>

<div><div class="CodeRay">
  <div class="code"><pre>h = {}

<span style="color:#080;font-weight:bold">def</span> h.<span style="color:#06B;font-weight:bold">[]=</span>(k, v)
  puts <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Setting hash key </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>k<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20"> with </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>v.inspect<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">&quot;</span></span>
  <span style="color:#080;font-weight:bold">super</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777"># 1. The standard ||= approach</span>
h[<span style="color:#A60">:x</span>] ||= <span style="color:#00D">10</span>
h[<span style="color:#A60">:x</span>] ||= <span style="color:#00D">20</span>

<span style="color:#777"># 2. The a = a || b approach</span>
h[<span style="color:#A60">:y</span>] = h[<span style="color:#A60">:y</span>] || <span style="color:#00D">10</span>
h[<span style="color:#A60">:y</span>] = h[<span style="color:#A60">:y</span>] || <span style="color:#00D">20</span>

<span style="color:#777"># 3. The a || a = b approach</span>
h[<span style="color:#A60">:z</span>] || h[<span style="color:#A60">:z</span>] = <span style="color:#00D">10</span>
h[<span style="color:#A60">:z</span>] || h[<span style="color:#A60">:z</span>] = <span style="color:#00D">20</span>
</pre></div>
</div>
</div>

<p>輸出為：</p>

<pre><code>Setting hash key x with 10
Setting hash key y with 10
Setting hash key y with 10
Setting hash key z with 10
</code></pre>

<p>還有一個 <code>&amp;&amp;=</code> 運算子，類似地，語義是 <code>a &amp;&amp; a = b</code>。</p>

<h3 id="for-">for 的視野</h3>
<p>出乎意料，<code>for</code> 並沒有開啟一個新的視野（与 <code>each</code> 不同），
所以在 <code>for</code> 的區塊中定義的變數會被外部看到。
因此，<a href="https://github.com/styleguide/ruby"><em>Ruby 風格指南</em></a> 中建議使用迭代器 (iterator) 取代之。</p>

<p>類似的 <code>if</code>, <code>while</code>, <code>case</code> 等也沒有開啟新的視野。</p>

<h3 id="heredoc">heredoc</h3>
<p>可以使用 heredoc 為字串賦值：</p>

<div><div class="CodeRay">
  <div class="code"><pre>hello = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&lt;&lt;END</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">
hello, world</span><span style="color:#710">
END</span></span>
</pre></div>
</div>
</div>

<p>但是這樣就不好看了：</p>

<div><div class="CodeRay">
  <div class="code"><pre><span style="color:#080;font-weight:bold">if</span> something
  hello = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&lt;&lt;END</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">
hello, world</span><span style="color:#710">
END</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>這樣好看一點（<code>END</code> 前多了一個 <code>-</code>）：</p>

<div><div class="CodeRay">
  <div class="code"><pre><span style="color:#080;font-weight:bold">if</span> something
  hello = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&lt;&lt;-END</span></span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">
hello, world</span><span style="color:#710">
  END</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>更好看一點？有點 trick… ：</p>

<div><div class="CodeRay">
  <div class="code"><pre><span style="color:#080;font-weight:bold">if</span> something
  hello = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&lt;&lt;-END</span></span>.gsub(<span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">^ {4}</span><span style="color:#404">/</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#710">'</span></span>)<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">
    hello, world</span><span style="color:#710">
  END</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>


    <address class="signature">
        <a class="author" href="/">Ng Cheuk-fung</a> 
        <span class="date">25 January 2013</span>
        <span class="location">Shenzhen, China</span>
    </address>
</div><!-- End Page -->
<!-- Disqus Comments -->
<div id="disqus_thread"></div>

<!-- Enable Disqus comments -->
<script type="text/javascript">
    var disqus_iframe_css = "leewings.github.io/files/css/screen.css";
    var disqus_title = "紅寶石學習筆記（四）";
    var disqus_message = "||= 運算子，for 的視野，heredoc";
</script>
<script type="text/javascript" src="http://disqus.com/forums/cheuk-fung/embed.js"></script>

<noscript>
    <a href="http://cheuk-fung.disqus.com/?url=ref">View the discussion thread.</a>
</noscript>





            <div id="footer">
                <address>
                    <span class="copyright">
                        Content by 
                        <a href="/">Ng Cheuk-fung</a>
                        <br />
                        Original design by 
                        <a href="http://mark.reid.name/">Mark Reid</a>
                    </span>
                    <span class="engine">
                        Powered by 
                        <a href="https://github.com/mojombo/jekyll/" title="A simple, blog aware, static site generator">Jekyll</a>
                        <br/>
                        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a>
                    </span>
                </address>
            </div>
        </div>
    </body>
</html>
